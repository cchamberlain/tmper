#!/usr/bin/env bash
#
# usage: tmper

NC='\033[0m'
RED='\033[0;31m'
GREEN='\033[0;32m'
CYAN='\033[0;36m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
YELLOW='\033[1;33m'

if ! hash cpath 2>/dev/null; then
  >&2 printf "%b- cpath required, installing globally... -%b" "$CYAN" "$NC"
  npm install -g cpath
fi

delete_flag=false

usage_short="${BLUE}usage: tmper [-d]"
usage_long="$usage_short\n-d: safe delete temporary directory at path (default: $delete_junc)"

usage_short="$usage_short\nuse -h to get supported command information.${NC}"

options=":dh"
shopt -u nocasematch
OPTIND=1
while getopts "$options" opt ; do
    case "$opt" in
    d )
      delete_flag=true
      ;;
   h )
      >&2 printf -- "%b\n" "$usage_long"
      exit 0
      ;;
    \?)
      >&2 printf -- "unknown option: -%b\n" "$OPTARG"
      >&2 printf -- "%b\n" "$usage_short"
      exit 1
      ;;
    : )
      >&2 printf -- "missing option argument for -%b\n" "$OPTARG"
      >&2 printf -- "%b\n" "$usage_short"
      exit 1
      ;;
    * )
      >&2 printf -- "unimplemented option: -%b\n" "$OPTARG"
      >&2 printf -- "%b\n" "$usage_short"
      exit 1
    esac
done
shift $((OPTIND-1))

generate_name() {
  < /dev/urandom tr -dc a-z | head -c${1:-32};echo;
}

win_dir_path="$(cpath -w "$dir_path")"

if [ "$delete_junc" = true ] ; then
  cmd //c rmdir "$win_dir_path" &>/dev/null
  exit 0
fi

# Perform junction, loop in case random returns the same name twice
junc_name="$(generate_name "$name_length")"
junc_path="$junc_root/$junc_name"
while [ -e "$junc_path" ] ; do
  junc_name="$(generate_name "$name_length")"
  junc_path="$junc_root/$junc_name"
done

win_junc_path="$(cpath -w "$junc_path")"

mkdir -p "$junc_root" &>/dev/null
cmd //c mklink //J "$win_junc_path" "$win_dir_path" &>/dev/null

printf "%s" "$junc_path"